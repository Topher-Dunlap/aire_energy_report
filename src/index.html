<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aire Apartments - Energy Usage Report Generator - Dakota IT Solutions</title>
    <script src="lib/chart.umd.js"></script>
    <script src="lib/papaparse.min.js"></script>
    <script src="lib/jszip.min.js"></script>
    <script src="energy-core.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #5D8C43;
            --primary-light: #78A55A;
            --primary-lighter: #A8D08D;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            border-left: 1px solid var(--gray-200);
            border-right: 1px solid var(--gray-200);
        }

        .header {
            background: white;
            color: var(--gray-900);
            padding: 48px 40px;
            text-align: center;
            border-bottom: 2px solid var(--primary);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .header p {
            font-size: 1.15rem;
            color: var(--gray-700);
            font-weight: 400;
        }

        .upload-section {
            padding: 48px 40px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .upload-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 2px dashed var(--gray-300);
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 600px;
            width: 100%;
        }

        .upload-box:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }

        .upload-box.dragover {
            background: #f0f7eb;
            border-color: var(--primary);
            border-style: solid;
        }

        .upload-box h3 {
            color: #78A55A;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .upload-box p {
            color: #6c757d;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: white;
            color: var(--primary);
            padding: 12px 28px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            transition: all 0.15s ease;
        }

        .upload-btn:hover {
            background: var(--primary);
            color: white;
        }

        .rate-input-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .rate-input-container label {
            display: block;
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .rate-input-container input {
            width: 200px;
            padding: 10px;
            font-size: 1.1em;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            text-align: center;
            transition: border-color 0.15s ease;
        }

        .rate-input-container input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(93, 140, 67, 0.1);
        }

        .file-list {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .file-item {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: white;
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.15s ease;
        }

        .remove-btn:hover {
            background: var(--danger);
            color: white;
        }

        .generate-btn {
            background: white;
            color: var(--primary);
            padding: 14px 48px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-size: 1.15em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.15s ease;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .generate-btn:hover {
            background: var(--primary);
            color: white;
        }

        .generate-btn:disabled {
            background: var(--gray-100);
            color: var(--gray-300);
            border-color: var(--gray-300);
            cursor: not-allowed;
        }

        .report-section {
            padding: 40px;
            display: none;
        }

        .report-section.active {
            display: block;
        }

        .report-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-200);
        }

        .report-header h2 {
            font-size: 2em;
            color: #495057;
            margin-bottom: 10px;
        }

        .report-meta {
            color: #6c757d;
            font-size: 1.1em;
        }

        .legend-box {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .legend-box h3 {
            color: var(--gray-700);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .legend-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }

        .legend-item strong {
            color: var(--gray-900);
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
        }

        .status-card.warning {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .status-card.error {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .status-card.success {
            border-color: #28a745;
            background: #d4edda;
        }

        .status-card h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .device-list {
            list-style: none;
        }

        .device-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-item.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .device-item.online {
            background: #d4edda;
            color: #155724;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--gray-200);
        }

        .chart-container h3 {
            text-align: center;
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .line-chart-wrapper {
            position: relative;
            height: 400px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table th {
            background: var(--gray-50);
            color: var(--gray-700);
            padding: 14px 16px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-200);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.95rem;
        }

        .data-table tr:hover {
            background: var(--gray-50);
        }

        .data-table tr.total-row {
            background: var(--gray-50);
            color: var(--gray-900);
            font-weight: 600;
            border-top: 2px solid var(--primary);
        }

        .data-table tr.total-row td {
            border-bottom: none;
            padding: 16px;
        }

        .highlight-no-data {
            background: #fff3cd !important;
            color: #856404 !important;
        }

        .highlight-partial-data {
            background: #cfe2ff !important;
            color: #084298 !important;
        }

        .status-cell {
            font-weight: 600;
            padding: 8px 12px !important;
            border-radius: 4px;
        }

        .status-all {
            background: #d4edda !important;
        }

        .status-all .status-cell {
            color: #155724;
        }

        .status-partial {
            background: #fff3cd !important;
        }

        .status-partial .status-cell {
            color: #856404;
        }

        .status-none {
            background: #f8d7da !important;
        }

        .status-none .status-cell {
            color: #721c24;
        }

        .expandable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .expandable-row:hover {
            background-color: rgba(0, 0, 0, 0.02) !important;
        }

        .expandable-row td:first-child::before {
            content: '\25B6  ';
            display: inline-block;
            transition: transform 0.2s;
            margin-right: 5px;
        }

        .expandable-row.expanded td:first-child::before {
            transform: rotate(90deg);
        }

        .detail-row {
            display: none;
            background: #f8f9fa !important;
        }

        .detail-row.visible {
            display: table-row;
        }

        .detail-row td {
            padding: 20px !important;
            border-top: none !important;
        }

        .device-detail-table {
            width: 100%;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
            margin: 0;
        }

        .device-detail-table th {
            background: var(--gray-50);
            color: var(--gray-700);
            padding: 10px;
            text-align: left;
            font-size: 0.85em;
            font-weight: 600;
            border-bottom: 1px solid var(--gray-200);
        }

        .device-detail-table td {
            padding: 10px !important;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9em;
        }

        .device-detail-table tr:last-child td {
            border-bottom: none;
        }

        .uptime-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .uptime-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 600;
        }

        .uptime-fill.low {
            background: var(--danger);
        }

        .uptime-fill.medium {
            background: var(--warning);
        }

        .download-section {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
        }

        .download-btn {
            background: white;
            color: var(--success);
            padding: 12px 36px;
            border: 2px solid var(--success);
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.15s ease;
        }

        .download-btn:hover {
            background: var(--success);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #78A55A;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .print-btn {
            background: white;
            color: var(--gray-700);
            padding: 12px 36px;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.15s ease;
        }

        .print-btn:hover {
            background: var(--gray-700);
            color: white;
            border-color: var(--gray-700);
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: white;
            color: #6c757d;
            font-size: 0.9em;
            border-top: 1px solid #e9ecef;
        }

        .footer a {
            color: #78A55A;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .validation-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .validation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .validation-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .validation-item.found {
            background: #d4edda;
            border-color: #28a745;
        }

        .validation-item.missing {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .validation-icon {
            font-size: 1.5em;
            margin-right: 12px;
            min-width: 30px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .validation-icon::before {
            content: '\25CB';
            color: #6c757d;
        }

        .validation-item.found .validation-icon::before {
            content: '\2713';
            color: #28a745;
            font-weight: bold;
        }

        .validation-item.missing .validation-icon::before {
            content: '\2717';
            color: #dc3545;
            font-weight: bold;
        }

        .validation-text {
            font-weight: 500;
            color: #495057;
        }

        .validation-item.found .validation-text {
            color: #155724;
        }

        .validation-item.missing .validation-text {
            color: #721c24;
        }

        #validationMessage {
            padding: 10px;
            border-radius: 5px;
        }

        #validationMessage.success {
            background: #d4edda;
            color: #155724;
        }

        #validationMessage.warning {
            background: #fff3cd;
            color: #856404;
        }

        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
            .upload-section, .download-section, .loading, .generate-btn, #generateBtn {
                display: none !important;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            /* CRITICAL: Force the report section to show in print even if .active isn't applied */
            .report-section {
                display: block !important;
            }
            .footer {
                page-break-after: avoid;
            }
            /* Ensure tables don't break across pages badly */
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            /* Hide chart canvases in print (they often render blank) */
            canvas {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Aire Apartments - Energy Usage Report</h1>
            <p>Professional energy analysis with device monitoring and outage tracking</p>
        </div>

        <div class="upload-section">
            <div class="upload-container">
                <div class="upload-box" id="dailyUploadBox">
                    <h3>Monthly Energy Reports</h3>
                    <p>Select ZIP file or individual CSV files (-1DAY.csv)</p>
                    <button class="upload-btn" id="nativeOpenBtn">
                        Select Files or ZIP
                    </button>
                    <div id="dailyFileList" class="file-list" style="display: none;"></div>
                </div>
            </div>

            <div class="validation-section" id="validationSection">
                <h3 style="color: #495057; margin-bottom: 15px; text-align: center;">Required Documents Checklist</h3>
                <div class="validation-grid">
                    <div class="validation-item" id="val-general">
                        <span class="validation-icon"></span>
                        <span class="validation-text">General Electric (Floors 8-14)</span>
                    </div>
                    <div class="validation-item" id="val-ac-8-9">
                        <span class="validation-icon"></span>
                        <span class="validation-text">AC/Heater (Floors 8-9)</span>
                    </div>
                    <div class="validation-item" id="val-ac-10-11">
                        <span class="validation-icon"></span>
                        <span class="validation-text">AC/Heater (Floors 10-11)</span>
                    </div>
                    <div class="validation-item" id="val-ac-12-14">
                        <span class="validation-icon"></span>
                        <span class="validation-text">AC/Heater (Floors 12-14)</span>
                    </div>
                </div>
                <div id="validationMessage" style="margin-top: 15px; text-align: center; font-weight: 600; color: #6c757d;">Upload monthly CSV files to begin validation</div>
            </div>

            <div class="rate-input-container">
                <label for="rateInput">Cost per kWh ($) <span style="color: #dc3545;">*</span></label>
                <input type="number" id="rateInput" value="" step="0.001" min="0" placeholder="Enter rate (e.g., 0.132)" required>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">Get this from your monthly Xcel invoice</p>
            </div>

            <button class="generate-btn" id="generateBtn" disabled>
                Generate Report
            </button>
        </div>

        <div class="loading" id="loadingSection">
            <div class="spinner"></div>
            <p>Processing your data... This may take a moment.</p>
        </div>

        <div class="report-section" id="reportSection">
            <div class="report-header">
                <h2 id="reportTitle">Energy Usage Report</h2>
                <div class="report-meta">
                    <p id="reportDate"></p>
                    <p id="reportRate"></p>
                </div>
            </div>

            <div class="legend-box">
                <h3>Report Guide</h3>
                <div class="legend-item">
                    <strong>Apartment:</strong> Unit number (click the arrow to expand and see individual device details)
                </div>
                <div class="legend-item">
                    <strong>PTAC Cost/kWh:</strong> Cost and usage for heating and air conditioning (PTAC devices)
                </div>
                <div class="legend-item">
                    <strong>In-Unit Cost/kWh:</strong> Cost and usage for all other electrical devices (lights, appliances, etc. from end-of-hall feeds)
                </div>
                <div class="legend-item">
                    <strong>Total Cost/kWh:</strong> Combined cost and usage for all devices in the apartment
                </div>
                <div class="legend-item">
                    <strong>Status Indicators:</strong>
                    <ul style="margin-top: 5px; margin-left: 20px;">
                        <li><strong style="color: #28a745;">✓ All Reporting:</strong> All devices reporting consistently (≥95% uptime)</li>
                        <li><strong style="color: #ffc107;">⚠ Partial:</strong> Some devices not reporting or intermittent connection (&lt;95% uptime)</li>
                        <li><strong style="color: #ffc107;">⚠ Intermittent:</strong> Devices reporting but with connectivity gaps</li>
                        <li><strong style="color: #dc3545;">✗ Not Reporting:</strong> No devices reporting any data</li>
                    </ul>
                </div>
                <div class="legend-item">
                    <strong>Connectivity:</strong> Percentage of time intervals where device successfully reported data (device is online and communicating)<br>
                    <strong>Runtime:</strong> Percentage of time intervals where device was actively drawing power (device is running/in use)
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container" style="width: 100%; margin-bottom: 30px;">
                    <h3>PTAC Connectivity Over Time</h3>
                    <div class="chart-wrapper" style="height: 400px;">
                        <canvas id="connectivityTimeChart"></canvas>
                    </div>
                </div>
                <div class="chart-container" style="width: 100%;">
                    <h3>Device Reporting Status</h3>
                    <div class="chart-wrapper" style="height: 350px;">
                        <canvas id="statusPieChart"></canvas>
                    </div>
                </div>
            </div>

            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Apartment</th>
                        <th>PTAC Cost</th>
                        <th>PTAC kWh</th>
                        <th>In-Unit Cost</th>
                        <th>In-Unit kWh</th>
                        <th>Total Cost</th>
                        <th>Total kWh</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>

            <div class="download-section">
                <button class="download-btn" onclick="downloadCSV()">
                    Download CSV Report
                </button>
                <button class="print-btn" onclick="window.print()">
                    Print Report
                </button>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2026 Dakota IT Solutions. All rights reserved.</p>
            <p>Professional energy monitoring and reporting solutions</p>
        </div>
    </div>

    <script>
        // Core logic loaded from energy-core.js (EnergyCore global)
        const {
            ptacSerials,
            knownApartments,
            serialToApartment,
            extractApartmentNumber,
            classifyRequiredFiles,
            aggregateEnergyData,
            extractHourlyConnectivityData,
            processOutageData
        } = EnergyCore;


        let dailyFilesData = [];
        let detailedFilesData = [];
        let processedData = null;
        let charts = {};

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // Check if JSZip loaded
            if (typeof JSZip === 'undefined') {
                alert('Error: ZIP file support library did not load. Please restart the application.');
            }
            
            // Native file dialog button
            document.getElementById('nativeOpenBtn').addEventListener('click', async function() {
                if (window.electronAPI) {
                    const files = await window.electronAPI.openFileDialog();
                    if (files && files.length > 0) {
                        await handleNativeFiles(files);
                    }
                }
            });

            // Drag and drop handler (still works in Electron)
            const box = document.getElementById('dailyUploadBox');
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });
            box.addEventListener('dragleave', () => {
                box.classList.remove('dragover');
            });
            box.addEventListener('drop', async (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    await handleFileUpload(e.dataTransfer.files);
                }
            });

            // Listen for files opened via File menu
            if (window.electronAPI) {
                window.electronAPI.onFilesSelected(async (files) => {
                    await handleNativeFiles(files);
                });
                // Listen for CSV export from menu
                window.electronAPI.onMenuExportCSV(() => {
                    downloadCSV();
                });
            }
            
        }); // End DOMContentLoaded

        // Handle files from native dialog (base64 buffers from main process)
        async function handleNativeFiles(files) {
            for (const fileInfo of files) {
                const buffer = Uint8Array.from(atob(fileInfo.buffer), c => c.charCodeAt(0));
                const blob = new Blob([buffer]);
                const file = new File([blob], fileInfo.name);
                
                if (fileInfo.name.endsWith('.zip')) {
                    // Show loading message
                    const validationMsg = document.getElementById('validationMessage');
                    validationMsg.textContent = '\u{1F4E6} Extracting ZIP file(s)...';
                    validationMsg.style.color = '#0d6efd';
                    await extractZipFile(file);
                } else if (fileInfo.name.endsWith('.csv')) {
                    if (fileInfo.name.includes('-1DAY')) {
                        dailyFilesData.push(file);
                    } else if (fileInfo.name.includes('-1H') || fileInfo.name.includes('-15MIN') || 
                               fileInfo.name.includes('-1MIN') || fileInfo.name.includes('-1SEC')) {
                        detailedFilesData.push(file);
                    }
                }
            }
            updateFileList();
            validateRequiredFiles();
        }


        async function handleFileUpload(files) {
            const fileArray = Array.from(files);
            
            // Check if any ZIP files
            const hasZip = fileArray.some(f => f.name.endsWith('.zip'));
            if (hasZip) {
                // Show a simple loading message
                const validationMsg = document.getElementById('validationMessage');
                validationMsg.textContent = 'Extracting ZIP file(s)...';
                validationMsg.style.color = '#0d6efd';
            }
            
            for (const file of fileArray) {
                
                // Handle ZIP files
                if (file.name.endsWith('.zip')) {
                    await extractZipFile(file);
                }
                // Handle CSV files
                else if (file.name.endsWith('.csv')) {
                    // Separate daily and detailed files
                    if (file.name.includes('-1DAY')) {
                        dailyFilesData.push(file);
                    } else if (file.name.includes('-1H') || file.name.includes('-15MIN') || 
                               file.name.includes('-1MIN') || file.name.includes('-1SEC')) {
                        detailedFilesData.push(file);
                    } else {
                    }
                } else {
                }
            }

            updateFileList();
            validateRequiredFiles();
        }

        async function extractZipFile(zipFile) {
            try {
                // Check if JSZip is available
                if (typeof JSZip === 'undefined') {
                    throw new Error('JSZip library not loaded. Please refresh the page.');
                }
                
                const zip = await JSZip.loadAsync(zipFile);
                const fileList = Object.keys(zip.files);
                
                let extractedCount = 0;
                
                for (const [filename, fileData] of Object.entries(zip.files)) {
                    // Skip directories and non-CSV files
                    if (fileData.dir) {
                        continue;
                    }
                    
                    if (!filename.endsWith('.csv')) {
                        continue;
                    }
                    
                    
                    try {
                        const blob = await fileData.async('blob');
                        const file = new File([blob], filename, { type: 'text/csv' });
                        
                        // Separate daily and detailed files
                        if (filename.includes('-1DAY')) {
                            dailyFilesData.push(file);
                            extractedCount++;
                        } else if (filename.includes('-1H') || filename.includes('-15MIN') || 
                                   filename.includes('-1MIN') || filename.includes('-1SEC')) {
                            detailedFilesData.push(file);
                            extractedCount++;
                        } else {
                        }
                    } catch (extractError) {
                    }
                }
                
                
                if (extractedCount === 0) {
                    alert('Warning: No CSV files were extracted from the ZIP. Please check that your ZIP contains CSV files.');
                }
                
            } catch (error) {
                alert('Error extracting ZIP file: ' + error.message + '\n\nPlease make sure you uploaded a valid ZIP file containing CSV files.');
            }
        }

        function updateFileList() {
            const listElement = document.getElementById('dailyFileList');
            const totalFiles = dailyFilesData.length + detailedFilesData.length;

            if (totalFiles > 0) {
                listElement.style.display = 'block';
                listElement.innerHTML = '<h4 style="margin-bottom: 10px;">Uploaded Files:</h4>';
                
                // Show daily files
                dailyFilesData.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>${file.name}</span>
                        <button class="remove-btn" onclick="removeFile('daily', ${index})">Remove</button>
                    `;
                    listElement.appendChild(fileItem);
                });
                
                // Show detailed files
                detailedFilesData.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <span>${file.name}</span>
                        <button class="remove-btn" onclick="removeFile('detailed', ${index})">Remove</button>
                    `;
                    listElement.appendChild(fileItem);
                });
            } else {
                listElement.style.display = 'none';
            }
        }

        function removeFile(type, index) {
            const targetArray = type === 'daily' ? dailyFilesData : detailedFilesData;
            targetArray.splice(index, 1);
            updateFileList();
            validateRequiredFiles();
        }

        function validateRequiredFiles() {
            const validationSection = document.getElementById('validationSection');
            validationSection.style.display = 'block';

            if (dailyFilesData.length === 0) {
                // Reset all to neutral state
                ['val-general', 'val-ac-8-9', 'val-ac-10-11', 'val-ac-12-14'].forEach(id => {
                    const element = document.getElementById(id);
                    element.classList.remove('found', 'missing');
                });
                const messageDiv = document.getElementById('validationMessage');
                messageDiv.className = '';
                messageDiv.style.color = '#6c757d';
                messageDiv.textContent = 'Upload monthly CSV files to begin validation';
                return;
            }

            const fileNames = dailyFilesData.map(f => f.name);
            const { requirements, allFound, foundCount } = classifyRequiredFiles(fileNames);

            // Map classification keys to DOM element IDs
            const keyToId = {
                'general': 'val-general',
                'ac-8-9': 'val-ac-8-9',
                'ac-10-11': 'val-ac-10-11',
                'ac-12-14': 'val-ac-12-14'
            };

            Object.entries(requirements).forEach(([key, req]) => {
                const element = document.getElementById(keyToId[key]);
                if (req.found) {
                    element.classList.remove('missing');
                    element.classList.add('found');
                } else {
                    element.classList.remove('found');
                    element.classList.add('missing');
                }
            });

            // Update validation message
            const messageDiv = document.getElementById('validationMessage');
            if (allFound) {
                messageDiv.className = 'success';
                messageDiv.style.color = '';
                messageDiv.textContent = '\u2713 All required documents are present!';
            } else {
                messageDiv.className = 'warning';
                messageDiv.style.color = '';
                messageDiv.textContent = `\u26A0 ${foundCount} of 4 required documents found. Please upload the missing files.`;
            }

            // Update generate button - only enable if all requirements are met
            updateGenerateButton(allFound);
        }

        function updateGenerateButton(validationPassed = null) {
            const btn = document.getElementById('generateBtn');
            
            // If validation check is provided, use it; otherwise check if we have files
            let shouldEnable = dailyFilesData.length > 0;
            
            // If we have files, check validation
            if (shouldEnable && validationPassed !== null) {
                shouldEnable = validationPassed;
            }
            
            btn.disabled = !shouldEnable;
            
            // Update button text based on validation
            if (dailyFilesData.length > 0 && !shouldEnable) {
                btn.textContent = 'Missing Required Documents';
            } else {
                btn.textContent = 'Generate Report';
            }
        }

        document.getElementById('generateBtn').addEventListener('click', generateReport);

        async function generateReport() {
            // Validate that rate is entered
            const rateInput = document.getElementById('rateInput');
            const rate = parseFloat(rateInput.value);
            
            if (!rateInput.value || isNaN(rate) || rate <= 0) {
                alert('Please enter a valid Cost per kWh rate before generating the report.\n\nYou can find this rate on your monthly Xcel invoice.');
                rateInput.focus();
                return;
            }
            
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('reportSection').classList.remove('active');

            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                await processFiles();
                displayReport();
            } catch (error) {
                alert('Error processing files: ' + error.message);
            }

            document.getElementById('loadingSection').classList.remove('active');
        }

        async function processFiles() {
            const costPerKwh = parseFloat(document.getElementById('rateInput').value);
            
            const dailyData = await Promise.all(
                dailyFilesData.map(file => parseCSVFile(file))
            );

            const detailedData = await Promise.all(
                detailedFilesData.map(file => parseCSVFile(file))
            );

            processedData = aggregateEnergyData(dailyData, detailedData, costPerKwh);
        }

        function parseCSVFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        resolve({ filename: file.name, data: results.data, headers: results.meta.fields });
                    },
                    error: (error) => reject(error)
                });
            });
        }


        function displayReport() {
            const { apartments, grandTotal, deviceTracking, deviceUptime, outageData, dateRange, costPerKwh, detailedDataForCharts } = processedData;

            if (dateRange.earliest && dateRange.latest) {
                const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                document.getElementById('reportTitle').textContent = 
                    `Energy Usage Report - ${formatDate(dateRange.earliest)} to ${formatDate(dateRange.latest)}`;
                document.getElementById('reportDate').textContent = 
                    `Report Period: ${formatDate(dateRange.earliest)} to ${formatDate(dateRange.latest)}`;
            }
            document.getElementById('reportRate').textContent = 
                `Rate: $${costPerKwh.toFixed(3)} per kWh`;

            displayCharts(apartments, grandTotal, deviceUptime, outageData, detailedDataForCharts);
            displayTable(apartments, grandTotal);

            document.getElementById('reportSection').classList.add('active');
            document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
        }

        function displayCharts(apartments, grandTotal, deviceUptime, outageData, detailedDataForCharts) {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Count apartments by status
            let fullyReporting = 0;
            let partiallyReporting = 0;
            let notReporting = 0;

            apartments.forEach(apt => {
                if (apt.hasNoAcData && apt.hasNoGenData) {
                    notReporting++;
                } else if (apt.hasNoAcData || apt.hasNoGenData || apt.hasMultipleDevices) {
                    partiallyReporting++;
                } else {
                    fullyReporting++;
                }
            });

            const totalApartments = apartments.length;

            // Create status pie chart
            charts.status = new Chart(document.getElementById('statusPieChart'), {
                type: 'pie',
                data: {
                    labels: [
                        `Fully Reporting (${fullyReporting})`,
                        `Partially Reporting (${partiallyReporting})`,
                        `Not Reporting (${notReporting})`
                    ],
                    datasets: [{
                        data: [fullyReporting, partiallyReporting, notReporting],
                        backgroundColor: [
                            '#28a745', // Green for fully reporting
                            '#ffc107', // Yellow for partially reporting
                            '#dc3545'  // Red for not reporting
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                padding: 15,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const count = context.parsed;
                                    const percentage = ((count / totalApartments) * 100).toFixed(1);
                                    return `${context.label}: ${percentage}% (${count} of ${totalApartments} apartments)`;
                                }
                            }
                        }
                    }
                }
            });

            // Create time-based connectivity chart
            if (detailedDataForCharts) {
                // Calculate average connectivity across all PTACs for each hour
                const allTimestamps = new Set();
                Object.values(detailedDataForCharts).forEach(aptData => {
                    aptData.forEach(point => allTimestamps.add(point.timestamp));
                });

                const timestamps = Array.from(allTimestamps).sort((a, b) => a - b);
                const connectivityByTime = timestamps.map(ts => {
                    let totalConnected = 0;
                    let totalDevices = 0;
                    
                    Object.values(detailedDataForCharts).forEach(aptData => {
                        const point = aptData.find(p => p.timestamp === ts);
                        if (point) {
                            totalConnected += point.connected;
                            totalDevices++;
                        }
                    });
                    
                    return totalDevices > 0 ? (totalConnected / totalDevices * 100) : 0;
                });

                const labels = timestamps.map(ts => {
                    const date = new Date(ts);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                // Sample every Nth point if we have too many data points
                const maxPoints = 100;
                const step = Math.ceil(timestamps.length / maxPoints);
                const sampledLabels = labels.filter((_, i) => i % step === 0);
                const sampledData = connectivityByTime.filter((_, i) => i % step === 0);

                charts.connectivity = new Chart(document.getElementById('connectivityTimeChart'), {
                    type: 'line',
                    data: {
                        labels: sampledLabels,
                        datasets: [{
                            label: 'Average PTAC Connectivity',
                            data: sampledData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Connectivity: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        size: 12
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Connectivity Percentage',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        function displayTable(apartments, grandTotal) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            apartments.forEach((apt, index) => {
                const row = tbody.insertRow();
                
                // Determine status based on uptime and data
                let status = '';
                let statusClass = '';
                let statusDetail = ''; // Additional detail about which device is missing
                
                // Count devices with data
                const hasAnyData = apt.totalKwh > 0;
                
                if (!hasAnyData || (apt.hasNoAcData && apt.hasNoGenData)) {
                    // No data at all from apartment
                    status = '✗ Not Reporting';
                    statusClass = 'status-none';
                } else if (apt.deviceDetails && apt.deviceDetails.length > 0) {
                    // We have device details with connectivity info
                    const devicesWithData = apt.deviceDetails.filter(d => d.hasData);
                    const devicesWithLowConnectivity = apt.deviceDetails.filter(d => d.connectivity !== null && parseFloat(d.connectivity) < 95 && d.hasData);
                    
                    if (devicesWithLowConnectivity.length > 0) {
                        // Has data but intermittent connectivity
                        status = '⚠ Intermittent';
                        statusClass = 'status-partial';
                    } else if (devicesWithData.length < 2) {
                        // Expected 2 devices (PTAC + In-Unit) but only one is reporting
                        status = '⚠ Partial';
                        statusClass = 'status-partial';
                        
                        // Determine which device is missing
                        const hasPTAC = devicesWithData.some(d => d.type === 'PTAC');
                        const hasInUnit = devicesWithData.some(d => d.type === 'In-Unit');
                        
                        if (!hasPTAC) {
                            statusDetail = '<br><small style="font-size: 0.85em; font-weight: 400;">Missing: PTAC</small>';
                        } else if (!hasInUnit) {
                            statusDetail = '<br><small style="font-size: 0.85em; font-weight: 400;">Missing: In-Unit</small>';
                        }
                    } else {
                        // All devices reporting with good uptime
                        status = '✓ All Reporting';
                        statusClass = 'status-all';
                    }
                } else {
                    // No detailed uptime data, fall back to simple check
                    if (apt.hasNoAcData && !apt.hasNoGenData) {
                        status = '⚠ Partial';
                        statusClass = 'status-partial';
                        statusDetail = '<br><small style="font-size: 0.85em; font-weight: 400;">Missing: PTAC</small>';
                    } else if (!apt.hasNoAcData && apt.hasNoGenData) {
                        status = '⚠ Partial';
                        statusClass = 'status-partial';
                        statusDetail = '<br><small style="font-size: 0.85em; font-weight: 400;">Missing: In-Unit</small>';
                    } else if (apt.hasNoAcData || apt.hasNoGenData) {
                        status = '⚠ Partial';
                        statusClass = 'status-partial';
                    } else {
                        status = '✓ All Reporting';
                        statusClass = 'status-all';
                    }
                }
                
                row.className = statusClass;
                
                // Make ALL rows expandable
                row.classList.add('expandable-row');
                row.setAttribute('data-apt', apt.aptNum);
                
                row.innerHTML = `
                    <td>${apt.aptNum}</td>
                    <td>$${apt.acCost.toFixed(2)}</td>
                    <td>${apt.acKwh.toFixed(2)}</td>
                    <td>$${apt.genCost.toFixed(2)}</td>
                    <td>${apt.genKwh.toFixed(2)}</td>
                    <td><strong>$${apt.totalCost.toFixed(2)}</strong></td>
                    <td><strong>${apt.totalKwh.toFixed(2)}</strong></td>
                    <td class="status-cell ${statusClass}">${status}${statusDetail}</td>
                `;

                // Add detail row for ALL apartments (even if no device details)
                const detailRow = tbody.insertRow();
                detailRow.className = 'detail-row';
                detailRow.setAttribute('data-apt', apt.aptNum);
                
                const detailCell = detailRow.insertCell();
                detailCell.colSpan = 8;
                
                let detailHTML = `
                    <table class="device-detail-table">
                        <thead>
                            <tr>
                                <th>Device Type</th>
                                <th>Device ID</th>
                                <th>Cost</th>
                                <th>kWh</th>
                                <th>Connectivity</th>
                                <th>Runtime</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                if (apt.deviceDetails && apt.deviceDetails.length > 0) {
                    apt.deviceDetails.forEach(device => {
                        let connectivityHTML = '';
                        let runtimeHTML = '';
                        let statusIndicator = '';
                        
                        if (!device.hasData || device.kwh === 0) {
                            // Device has no data - mark as not reporting
                            connectivityHTML = '<span style="color: #dc3545; font-weight: 600;">NOT REPORTING</span>';
                            runtimeHTML = '<span style="color: #6c757d;">-</span>';
                            statusIndicator = ' style="background-color: #f8d7da;"';
                        } else if (device.connectivity !== null) {
                            // Show connectivity
                            const connectivityPercent = parseFloat(device.connectivity);
                            let connectivityClass = '';
                            if (connectivityPercent >= 95) connectivityClass = '';
                            else if (connectivityPercent >= 80) connectivityClass = 'medium';
                            else connectivityClass = 'low';
                            
                            connectivityHTML = `
                                <div class="uptime-bar">
                                    <div class="uptime-fill ${connectivityClass}" style="width: ${connectivityPercent}%">
                                        ${connectivityPercent}%
                                    </div>
                                </div>
                            `;
                            
                            // Show runtime
                            if (device.runtime !== null) {
                                const runtimePercent = parseFloat(device.runtime);
                                let runtimeClass = '';
                                // Runtime coloring is different - it's about usage, not quality
                                if (runtimePercent >= 50) runtimeClass = '';
                                else if (runtimePercent >= 20) runtimeClass = 'medium';
                                else runtimeClass = 'low';
                                
                                runtimeHTML = `
                                    <div class="uptime-bar">
                                        <div class="uptime-fill ${runtimeClass}" style="width: ${runtimePercent}%">
                                            ${runtimePercent}%
                                        </div>
                                    </div>
                                `;
                            } else {
                                runtimeHTML = '<span style="color: #6c757d;">-</span>';
                            }
                        } else {
                            connectivityHTML = '<span style="color: #6c757d;">No interval data</span>';
                            runtimeHTML = '<span style="color: #6c757d;">-</span>';
                        }
                        
                        detailHTML += `
                            <tr${statusIndicator}>
                                <td><strong>${device.type}</strong></td>
                                <td>${device.deviceId}</td>
                                <td>$${device.cost.toFixed(2)}</td>
                                <td>${device.kwh.toFixed(2)}</td>
                                <td>${connectivityHTML}</td>
                                <td>${runtimeHTML}</td>
                            </tr>
                        `;
                    });
                } else {
                    // PTAC row
                    let ptacStatusIndicator = apt.acKwh === 0 ? ' style="background-color: #f8d7da;"' : '';
                    let ptacUptimeHTML = apt.acKwh === 0 
                        ? '<span style="color: #dc3545; font-weight: 600;">NOT REPORTING</span>' 
                        : '<span style="color: #6c757d;">No interval data</span>';
                    
                    detailHTML += `
                        <tr${ptacStatusIndicator}>
                            <td><strong>PTAC</strong></td>
                            <td>-</td>
                            <td>$${apt.acCost.toFixed(2)}</td>
                            <td>${apt.acKwh.toFixed(2)}</td>
                            <td>${ptacUptimeHTML}</td>
                        </tr>
                    `;
                    
                    // In-Unit row
                    let inUnitStatusIndicator = apt.genKwh === 0 ? ' style="background-color: #f8d7da;"' : '';
                    let inUnitUptimeHTML = apt.genKwh === 0 
                        ? '<span style="color: #dc3545; font-weight: 600;">NOT REPORTING</span>' 
                        : '<span style="color: #6c757d;">No interval data</span>';
                    
                    detailHTML += `
                        <tr${inUnitStatusIndicator}>
                            <td><strong>In-Unit</strong></td>
                            <td>-</td>
                            <td>$${apt.genCost.toFixed(2)}</td>
                            <td>${apt.genKwh.toFixed(2)}</td>
                            <td>${inUnitUptimeHTML}</td>
                        </tr>
                    `;
                }
                
                detailHTML += `
                        </tbody>
                    </table>
                `;
                
                detailCell.innerHTML = detailHTML;
            });

            const totalRow = tbody.insertRow();
            totalRow.classList.add('total-row');
            totalRow.innerHTML = `
                <td>GRAND TOTAL</td>
                <td>$${grandTotal.acCost.toFixed(2)}</td>
                <td>${grandTotal.acKwh.toFixed(2)}</td>
                <td>$${grandTotal.genCost.toFixed(2)}</td>
                <td>${grandTotal.genKwh.toFixed(2)}</td>
                <td><strong>$${grandTotal.cost.toFixed(2)}</strong></td>
                <td><strong>${grandTotal.kwh.toFixed(2)}</strong></td>
                <td></td>
            `;

            // Add click handlers for all expandable rows
            document.querySelectorAll('.expandable-row').forEach(row => {
                row.addEventListener('click', function() {
                    const aptNum = this.getAttribute('data-apt');
                    const detailRow = document.querySelector(`.detail-row[data-apt="${aptNum}"]`);
                    
                    if (detailRow) {
                        this.classList.toggle('expanded');
                        detailRow.classList.toggle('visible');
                    }
                });
            });
        }

        async function downloadCSV() {
            if (!processedData) {
                alert('Please generate a report first before downloading.');
                return;
            }
            const { apartments, grandTotal, dateRange, costPerKwh } = processedData;
            
            let csv = 'Apartment,PTAC Cost,PTAC kWh,In-Unit Cost,In-Unit kWh,Total Cost,Total kWh,Status\n';
            
            apartments.forEach(apt => {
                let status = '';
                if (apt.hasNoAcData && apt.hasNoGenData) {
                    status = 'Not Reporting';
                } else if (apt.hasNoAcData || apt.hasNoGenData || apt.hasMultipleDevices) {
                    status = 'Partial';
                } else {
                    status = 'All Reporting';
                }
                
                csv += `${apt.aptNum},${apt.acCost.toFixed(2)},${apt.acKwh.toFixed(2)},`;
                csv += `${apt.genCost.toFixed(2)},${apt.genKwh.toFixed(2)},`;
                csv += `${apt.totalCost.toFixed(2)},${apt.totalKwh.toFixed(2)},${status}\n`;
            });

            csv += `GRAND TOTAL,${grandTotal.acCost.toFixed(2)},${grandTotal.acKwh.toFixed(2)},`;
            csv += `${grandTotal.genCost.toFixed(2)},${grandTotal.genKwh.toFixed(2)},`;
            csv += `${grandTotal.cost.toFixed(2)},${grandTotal.kwh.toFixed(2)},\n`;
            
            csv += `\nRate per kWh: $${costPerKwh.toFixed(3)}\n`;
            if (dateRange.earliest && dateRange.latest) {
                csv += `Report Period: ${dateRange.earliest.toLocaleDateString()} to ${dateRange.latest.toLocaleDateString()}\n`;
            }

            let filename = 'energy_summary';
            if (dateRange.earliest && dateRange.latest) {
                const formatDate = (d) => d.toISOString().split('T')[0];
                filename += `_${formatDate(dateRange.earliest)}_to_${formatDate(dateRange.latest)}`;
            }
            filename += '.csv';

            // Use native Save As dialog in Electron
            if (window.electronAPI) {
                const result = await window.electronAPI.saveCSV(csv, filename);
                if (result.success) {
                    alert('Report saved to: ' + result.path);
                }
            } else {
                // Fallback for browser
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
            }
        }
    </script>
</body>
</html>
